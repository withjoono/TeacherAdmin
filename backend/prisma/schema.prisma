generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["multiSchema"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["teacher_admin", "hub", "tutorboard"]
}

/// 아레나 클래스 (반/그룹)
model Arena {
  id          BigInt   @id @default(autoincrement())
  arenaCode   String   @unique @map("arena_code") @db.VarChar(20)
  name        String   @db.VarChar(100)
  description String?  @db.Text
  ownerId     String   @map("owner_id") @db.VarChar(50)
  inviteCode  String   @unique @map("invite_code") @db.VarChar(10)
  maxMembers  Int      @default(50) @map("max_members")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  members   ArenaMember[]
  snapshots DailySnapshot[]

  @@index([ownerId], name: "idx_sa_arena_owner")
  @@index([inviteCode], name: "idx_sa_arena_invite")
  @@map("sa_arena")
  @@schema("teacher_admin")
}

/// 아레나 멤버십 (학생-클래스 연결)
model ArenaMember {
  id           BigInt   @id @default(autoincrement())
  arenaId      BigInt   @map("arena_id")
  studentId    String   @map("student_id") @db.VarChar(50)
  hubMemberId  String?  @map("hub_member_id") @db.VarChar(50)
  authMemberId String?  @map("auth_member_id") @db.VarChar(50)
  role         String   @default("member") @db.VarChar(20)
  joinedAt     DateTime @default(now()) @map("joined_at")
  isActive     Boolean  @default(true) @map("is_active")

  // Relations
  arena      Arena           @relation(fields: [arenaId], references: [id], onDelete: Cascade)
  authMember AuthMember?     @relation(fields: [authMemberId], references: [id])
  snapshots  DailySnapshot[]

  @@unique([arenaId, studentId], name: "uk_sa_arena_member")
  @@index([arenaId], name: "idx_sa_member_arena")
  @@index([studentId], name: "idx_sa_member_student")
  @@index([hubMemberId], name: "idx_sa_member_hub")
  @@index([authMemberId], name: "idx_sa_member_auth")
  @@map("sa_arena_member")
  @@schema("teacher_admin")
}

/// 통합 인증 멤버 (Hub SSO 연동)
model AuthMember {
  id        String   @id @db.VarChar(50)
  hubId     BigInt   @unique @map("hub_id")
  createdAt DateTime @default(now()) @map("created_at")
  lastLogin DateTime @default(now()) @map("last_login")

  // Relations
  arenaMembers ArenaMember[]

  @@map("sa_auth_member")
  @@schema("teacher_admin")
}

/// 일간 학습 성과 스냅샷
model DailySnapshot {
  id                BigInt   @id @default(autoincrement())
  arenaId           BigInt   @map("arena_id")
  memberId          BigInt   @map("member_id")
  studentId         String   @map("student_id") @db.VarChar(50)
  date              DateTime @db.Date
  totalMissions     Int      @default(0) @map("total_missions")
  completedMissions Int      @default(0) @map("completed_missions")
  achievementPct    Decimal  @default(0) @map("achievement_pct") @db.Decimal(5, 2)
  totalStudyMin     Int      @default(0) @map("total_study_min")
  avgFocusRate      Decimal? @map("avg_focus_rate") @db.Decimal(3, 2)
  score             Decimal  @default(0) @db.Decimal(7, 2)
  createdAt         DateTime @default(now()) @map("created_at")

  // Relations
  arena  Arena       @relation(fields: [arenaId], references: [id], onDelete: Cascade)
  member ArenaMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@unique([arenaId, studentId, date], name: "uk_sa_snapshot_arena_student_date")
  @@index([arenaId, date], name: "idx_sa_snapshot_arena_date")
  @@index([memberId], name: "idx_sa_snapshot_member")
  @@map("sa_daily_snapshot")
  @@schema("teacher_admin")
}

/// Hub 공유 인증 테이블 (읽기 전용)
model auth_member {
  id                    String          @id @db.VarChar(30)
  email                 String          @db.VarChar(500)
  password              String?         @db.VarChar(500)
  role_type             String?         @db.VarChar(500)
  phone                 String?         @db.VarChar(255)
  nickname              String?         @db.VarChar(255)
  member_type           String?         @db.VarChar(20)
  provider_type         String?         @db.VarChar(20)
  create_dt             DateTime?       @db.Timestamp(6)
  update_dt             DateTime?       @db.Timestamp(6)

  auth_member_s         auth_member_s?

  @@index([email, phone], map: "idx_auth_member_email_phone")
  @@schema("hub")
}

/// Hub 학생 상세 정보 (읽기 전용)
model auth_member_s {
  member_id       String      @id @db.VarChar(30)
  school_code     String?     @db.VarChar(20)
  school_name     String?     @db.VarChar(100)
  school_location String?     @db.VarChar(50)
  school_type     String?     @db.VarChar(50)
  school_level    String?     @db.VarChar(10)
  grade           Int?
  auth_member     auth_member @relation(fields: [member_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@schema("hub")
}

// ===== TUTORBOARD ENUMS =====

enum UserRole {
  teacher
  parent
  student

  @@schema("tutorboard")
}

enum SubmissionStatus {
  pending
  submitted
  graded

  @@schema("tutorboard")
}

enum PaymentStatus {
  pending
  paid
  overdue

  @@schema("tutorboard")
}

enum NotificationType {
  assignment
  test
  payment
  attendance
  comment
  general

  @@schema("tutorboard")
}

enum AttendanceStatus {
  present
  late
  absent

  @@schema("tutorboard")
}

// ===== TUTORBOARD USERS =====

model TbUser {
  id         String   @id @default(uuid())
  hubUserId  Int?     @unique @map("hub_user_id")
  username   String
  email      String   @unique
  role       UserRole
  phone      String?
  avatarUrl  String?  @map("avatar_url")
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  teacherClasses       TbClass[]
  studentEnrollments   TbClassEnrollment[] @relation("StudentEnrollments")
  parentEnrollments    TbClassEnrollment[] @relation("ParentEnrollments")
  submissions          TbAssignmentSubmission[]
  testResults          TbTestResult[]
  studentPayments      TbPayment[]
  notifications        TbNotification[]
  badges               TbStudentBadge[]
  attendances          TbAttendance[]
  sentComments         TbPrivateComment[]    @relation("CommentAuthor")
  receivedComments     TbPrivateComment[]    @relation("CommentTarget")
  sentMessages         TbMessage[]

  @@map("tb_users")
  @@schema("tutorboard")
}

// ===== TUTORBOARD CLASSES =====

model TbClass {
  id          String   @id @default(uuid())
  teacherId   String   @map("teacher_id")
  name        String
  subject     String   @default("기타")
  description String?
  inviteCode  String   @unique @map("invite_code")
  startDate   DateTime? @map("start_date")
  endDate     DateTime? @map("end_date")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  teacher     TbUser         @relation(fields: [teacherId], references: [id])
  enrollments TbClassEnrollment[]
  lessonPlans TbLessonPlan[]
  payments    TbPayment[]
  attendances TbAttendance[]

  @@map("tb_classes")
  @@schema("tutorboard")
}

model TbClassEnrollment {
  id         String   @id @default(uuid())
  classId    String   @map("class_id")
  studentId  String   @map("student_id")
  parentId   String?  @map("parent_id")
  enrolledAt DateTime @default(now()) @map("enrolled_at")

  // Relations
  class   TbClass @relation(fields: [classId], references: [id])
  student TbUser  @relation("StudentEnrollments", fields: [studentId], references: [id])
  parent  TbUser? @relation("ParentEnrollments", fields: [parentId], references: [id])

  @@unique([classId, studentId])
  @@map("tb_class_enrollments")
  @@schema("tutorboard")
}

// ===== TUTORBOARD LESSON PLANS & RECORDS =====

model TbLessonPlan {
  id            String   @id @default(uuid())
  classId       String   @map("class_id")
  title         String
  description   String?
  scheduledDate DateTime? @map("scheduled_date")
  progress      Int      @default(0)
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  class       TbClass          @relation(fields: [classId], references: [id])
  assignments TbAssignment[]
  tests       TbTest[]
  records     TbLessonRecord[]

  @@map("tb_lesson_plans")
  @@schema("tutorboard")
}

model TbLessonRecord {
  id           String   @id @default(uuid())
  lessonPlanId String   @map("lesson_plan_id")
  recordDate   DateTime @map("record_date")
  summary      String?
  pagesFrom    Int?     @map("pages_from")
  pagesTo      Int?     @map("pages_to")
  conceptNote  String?  @map("concept_note")
  fileUrl      String?  @map("file_url")
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  lessonPlan TbLessonPlan @relation(fields: [lessonPlanId], references: [id])

  @@map("tb_lesson_records")
  @@schema("tutorboard")
}

// ===== TUTORBOARD ATTENDANCE =====

model TbAttendance {
  id        String           @id @default(uuid())
  classId   String           @map("class_id")
  studentId String           @map("student_id")
  date      DateTime
  status    AttendanceStatus @default(present)
  note      String?
  createdAt DateTime         @default(now()) @map("created_at")

  // Relations
  class   TbClass @relation(fields: [classId], references: [id])
  student TbUser  @relation(fields: [studentId], references: [id])

  @@unique([classId, studentId, date])
  @@map("tb_attendances")
  @@schema("tutorboard")
}

// ===== TUTORBOARD ASSIGNMENTS =====

model TbAssignment {
  id          String   @id @default(uuid())
  lessonId    String   @map("lesson_id")
  title       String
  description String?
  dueDate     DateTime? @map("due_date")
  fileUrl     String?  @map("file_url")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  lesson      TbLessonPlan          @relation(fields: [lessonId], references: [id])
  submissions TbAssignmentSubmission[]

  @@map("tb_assignments")
  @@schema("tutorboard")
}

model TbAssignmentSubmission {
  id                String           @id @default(uuid())
  assignmentId      String           @map("assignment_id")
  studentId         String           @map("student_id")
  submissionFileUrl String?          @map("submission_file_url")
  feedback          String?
  grade             Int?
  status            SubmissionStatus @default(pending)
  submittedAt       DateTime         @default(now()) @map("submitted_at")

  // Relations
  assignment TbAssignment @relation(fields: [assignmentId], references: [id])
  student    TbUser       @relation(fields: [studentId], references: [id])

  @@unique([assignmentId, studentId])
  @@map("tb_assignment_submissions")
  @@schema("tutorboard")
}

// ===== TUTORBOARD TESTS =====

model TbTest {
  id          String   @id @default(uuid())
  lessonId    String   @map("lesson_id")
  title       String
  description String?
  testDate    DateTime? @map("test_date")
  maxScore    Int      @map("max_score")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  lesson  TbLessonPlan   @relation(fields: [lessonId], references: [id])
  results TbTestResult[]

  @@map("tb_tests")
  @@schema("tutorboard")
}

model TbTestResult {
  id              String   @id @default(uuid())
  testId          String   @map("test_id")
  studentId       String   @map("student_id")
  score           Int
  feedback        String?
  wrongAnswerNote String?  @map("wrong_answer_note")
  takenAt         DateTime @default(now()) @map("taken_at")

  // Relations
  test    TbTest @relation(fields: [testId], references: [id])
  student TbUser @relation(fields: [studentId], references: [id])

  @@unique([testId, studentId])
  @@map("tb_test_results")
  @@schema("tutorboard")
}

// ===== TUTORBOARD PAYMENTS =====

model TbPayment {
  id         String        @id @default(uuid())
  classId    String        @map("class_id")
  studentId  String        @map("student_id")
  amount     Decimal
  dueDate    DateTime      @map("due_date")
  paidDate   DateTime?     @map("paid_date")
  status     PaymentStatus @default(pending)
  receiptUrl String?       @map("receipt_url")
  createdAt  DateTime      @default(now()) @map("created_at")

  // Relations
  class   TbClass @relation(fields: [classId], references: [id])
  student TbUser  @relation(fields: [studentId], references: [id])

  @@map("tb_payments")
  @@schema("tutorboard")
}

// ===== TUTORBOARD NOTIFICATIONS =====

model TbNotification {
  id            String           @id @default(uuid())
  userId        String           @map("user_id")
  message       String
  type          NotificationType @default(general)
  read          Boolean          @default(false)
  referenceId   String?          @map("reference_id")
  referenceType String?          @map("reference_type")
  sentAt        DateTime         @default(now()) @map("sent_at")

  // Relations
  user TbUser @relation(fields: [userId], references: [id])

  @@map("tb_notifications")
  @@schema("tutorboard")
}

// ===== TUTORBOARD PRIVATE COMMENTS =====

model TbPrivateComment {
  id          String   @id @default(uuid())
  authorId    String   @map("author_id")
  targetId    String   @map("target_id")
  studentId   String?  @map("student_id")
  contextType String?  @map("context_type")
  contextId   String?  @map("context_id")
  content     String
  imageUrl    String?  @map("image_url")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  author TbUser @relation("CommentAuthor", fields: [authorId], references: [id])
  target TbUser @relation("CommentTarget", fields: [targetId], references: [id])

  @@map("tb_private_comments")
  @@schema("tutorboard")
}

// ===== TUTORBOARD MESSAGING =====

model TbConversation {
  id        String   @id @default(uuid())
  teacherId String   @map("teacher_id")
  parentId  String   @map("parent_id")
  studentId String?  @map("student_id")
  title     String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  messages TbMessage[]

  @@unique([teacherId, parentId, studentId])
  @@map("tb_conversations")
  @@schema("tutorboard")
}

model TbMessage {
  id             String   @id @default(uuid())
  conversationId String   @map("conversation_id")
  senderId       String   @map("sender_id")
  content        String
  contextType    String?  @map("context_type")
  contextId      String?  @map("context_id")
  read           Boolean  @default(false)
  sentAt         DateTime @default(now()) @map("sent_at")

  // Relations
  conversation TbConversation @relation(fields: [conversationId], references: [id])
  sender       TbUser         @relation(fields: [senderId], references: [id])

  @@map("tb_messages")
  @@schema("tutorboard")
}

// ===== TUTORBOARD BADGES =====

model TbStudentBadge {
  id        String   @id @default(uuid())
  studentId String   @map("student_id")
  badgeType String   @map("badge_type")
  badgeName String   @map("badge_name")
  earnedAt  DateTime @default(now()) @map("earned_at")

  // Relations
  student TbUser @relation(fields: [studentId], references: [id])

  @@map("tb_student_badges")
  @@schema("tutorboard")
}

// ===== SHARED SCHEDULE (Hub Schema) =====

model HubSharedSchedule {
  id          BigInt    @id @default(autoincrement())
  hubUserId   String    @map("hub_user_id") @db.VarChar(100)
  sourceApp   String    @map("source_app") @db.VarChar(20)
  eventType   String    @map("event_type") @db.VarChar(30)
  sourceId    String    @map("source_id") @db.VarChar(50)
  title       String    @db.VarChar(200)
  description String?   @db.Text
  eventDate   DateTime  @map("event_date") @db.Date
  startTime   DateTime? @map("start_time") @db.Time(0)
  endTime     DateTime? @map("end_time") @db.Time(0)
  subject     String?   @db.VarChar(50)
  metadata    Json?
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@unique([sourceApp, eventType, sourceId], name: "uk_hub_schedule_source")
  @@index([hubUserId], name: "idx_hub_schedule_user")
  @@index([hubUserId, eventDate], name: "idx_hub_schedule_date")
  @@map("hub_shared_schedule")
  @@schema("hub")
}
