generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// 아레나 클래스 (반/그룹)
model Arena {
  id          BigInt   @id @default(autoincrement())
  arenaCode   String   @unique @map("arena_code") @db.VarChar(20)
  name        String   @db.VarChar(100)
  description String?  @db.Text
  ownerId     BigInt   @map("owner_id")
  inviteCode  String   @unique @map("invite_code") @db.VarChar(10)
  maxMembers  Int      @default(50) @map("max_members")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  members   ArenaMember[]
  snapshots DailySnapshot[]

  @@index([ownerId], name: "idx_sa_arena_owner")
  @@index([inviteCode], name: "idx_sa_arena_invite")
  @@map("sa_arena")
}

/// 아레나 멤버십 (학생-클래스 연결)
model ArenaMember {
  id           BigInt   @id @default(autoincrement())
  arenaId      BigInt   @map("arena_id")
  studentId    BigInt   @map("student_id")
  hubMemberId  BigInt?  @map("hub_member_id")
  authMemberId String?  @map("auth_member_id") @db.VarChar(50)
  role         String   @default("member") @db.VarChar(20)
  joinedAt     DateTime @default(now()) @map("joined_at")
  isActive     Boolean  @default(true) @map("is_active")

  // Relations
  arena      Arena           @relation(fields: [arenaId], references: [id], onDelete: Cascade)
  authMember AuthMember?     @relation(fields: [authMemberId], references: [id])
  snapshots  DailySnapshot[]

  @@unique([arenaId, studentId], name: "uk_sa_arena_member")
  @@index([arenaId], name: "idx_sa_member_arena")
  @@index([studentId], name: "idx_sa_member_student")
  @@index([hubMemberId], name: "idx_sa_member_hub")
  @@index([authMemberId], name: "idx_sa_member_auth")
  @@map("sa_arena_member")
}

/// 통합 인증 멤버 (Hub SSO 연동)
model AuthMember {
  id        String   @id @db.VarChar(50)
  hubId     BigInt   @unique @map("hub_id")
  createdAt DateTime @default(now()) @map("created_at")
  lastLogin DateTime @default(now()) @map("last_login")

  // Relations
  arenaMembers ArenaMember[]

  @@map("sa_auth_member")
}

/// 일간 학습 성과 스냅샷
model DailySnapshot {
  id                BigInt   @id @default(autoincrement())
  arenaId           BigInt   @map("arena_id")
  memberId          BigInt   @map("member_id")
  studentId         BigInt   @map("student_id")
  date              DateTime @db.Date
  totalMissions     Int      @default(0) @map("total_missions")
  completedMissions Int      @default(0) @map("completed_missions")
  achievementPct    Decimal  @default(0) @map("achievement_pct") @db.Decimal(5, 2)
  totalStudyMin     Int      @default(0) @map("total_study_min")
  avgFocusRate      Decimal? @map("avg_focus_rate") @db.Decimal(3, 2)
  score             Decimal  @default(0) @db.Decimal(7, 2)
  createdAt         DateTime @default(now()) @map("created_at")

  // Relations
  arena  Arena       @relation(fields: [arenaId], references: [id], onDelete: Cascade)
  member ArenaMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@unique([arenaId, studentId, date], name: "uk_sa_snapshot_arena_student_date")
  @@index([arenaId, date], name: "idx_sa_snapshot_arena_date")
  @@index([memberId], name: "idx_sa_snapshot_member")
  @@map("sa_daily_snapshot")
}

/// Hub 공유 인증 테이블 (읽기 전용)
model auth_member {
  id                    String          @id @db.VarChar(30)
  email                 String          @db.VarChar(500)
  password              String?         @db.VarChar(500)
  role_type             String?         @db.VarChar(500)
  phone                 String?         @db.VarChar(255)
  nickname              String?         @db.VarChar(255)
  member_type           String?         @db.VarChar(20)
  provider_type         String?         @db.VarChar(20)
  create_dt             DateTime?       @db.Timestamp(6)
  update_dt             DateTime?       @db.Timestamp(6)

  auth_member_s         auth_member_s?

  @@index([email, phone], map: "idx_auth_member_email_phone")
}

/// Hub 학생 상세 정보 (읽기 전용)
model auth_member_s {
  member_id       String      @id @db.VarChar(30)
  school_code     String?     @db.VarChar(20)
  school_name     String?     @db.VarChar(100)
  school_location String?     @db.VarChar(50)
  school_type     String?     @db.VarChar(50)
  school_level    String?     @db.VarChar(10)
  grade           Int?
  auth_member     auth_member @relation(fields: [member_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}
